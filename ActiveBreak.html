<head>
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@1.3.1/dist/tf.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@teachablemachine/pose@0.8/dist/teachablemachine-pose.min.js"></script>
  <script src="components.dll.js"></script>
  <script src="bundle.js"></script>
  <script src="https://code.jquery.com/jquery-2.2.4.min.js"></script>
  <link
    rel="stylesheet"
    href="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css"
  />
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.16.0/umd/popper.min.js"></script>
  <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
  <title>Active Breaker</title>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta
    property="og:image"
    content="https://cdn.glitch.com/9c389208-b279-4e96-bcbc-e5f8712d8706%2Ftheme-builder-meta%20copy.png?1555366209261"
  />
  <!-- import Material Icons from Google Fonts -->
  <link
    rel="stylesheet"
    href="https://fonts.googleapis.com/icon?family=Material+Icons"
  />
  <link
    href="https://fonts.googleapis.com/css?family=Roboto+Mono|Roboto:900i"
    rel="stylesheet"
  />
  <link
    href="https://fonts.googleapis.com/css?family=Roboto:300,400,500"
    rel="stylesheet"
  />
  <!-- import the Material stylesheet -->
  <link rel="stylesheet" href="bundle.css" />
  <!-- Add favicons -->
  <link
    rel="icon"
    type="image/png"
    sizes="32x32"
    href="https://cdn.glitch.com/9c389208-b279-4e96-bcbc-e5f8712d8706%2Ffavicon-32x32.png?1553712190412"
  />
  <link
    rel="icon"
    type="image/png"
    sizes="96x96"
    href="https://cdn.glitch.com/9c389208-b279-4e96-bcbc-e5f8712d8706%2Ffavicon-96x96.png?1553712190613"
  />
  <link
    rel="icon"
    type="image/png"
    sizes="16x16"
    href="https://cdn.glitch.com/9c389208-b279-4e96-bcbc-e5f8712d8706%2Ffavicon-16x16.png?1553712190383"
  />
  <!--- Notification ring--->
</head>

<body class="mdc-typography" onload="init()">
    <main>
  <nav class="navbar bg-dark navbar-dark">
    <!-- Brand -->
    <a class="navbar-brand" href="#">Active Breaker</a>

    <!-- Toggler/collapsibe Button -->
    <button
      class="navbar-toggler"
      type="button"
      data-toggle="collapse"
      data-target="#collapsibleNavbar"
    >
      <span class="navbar-toggler-icon"></span>
    </button>

    <!-- Navbar links -->
    <div class="collapse navbar-collapse" id="collapsibleNavbar">
      <ul class="navbar-nav">
        <li class="nav-item">
          <a class="nav-link" href="index.html">Home</a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="form.html">Settings</a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="ActiveBreak.html">Start Active Break</a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="Work.html">Start Working</a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="stats.html">Statistics</a>
        </li>
      </ul>
    </div>
  </nav>
  <br />


    <!--Ping-->
    <audio id="aud">
      <source
        src="https://cdn.glitch.com/344122ff-b96f-4b0e-b327-a5fea0abf4a7%2FA-Tone-His_Self-1266414414.mp3?v=1596449765553"
        type="audio/mpeg"
        id="bing"
      />
    </audio>

    <!--button--->
    <div class="container">
      <div id="nextExercise"></div>
      <div id="progressBar">
        <div class="bar"></div>
      </div>

      <!-- trainer -->

      <div class="container-fluid">
        <div class="container-fluid">
          <!-- Control the column width, and how they should appear on different devices -->
          <div class="row">
            <div class="col-sm-6">
              <div id="TM">
                <div><canvas id="canvas"></canvas></div>
                <div id="exerciseName">"
                  
                </div>
                <div id="feedback">
                  <p></p>
                </div>
                <div id="label-container"></div>
              </div>
            </div>
            <div class="col-sm-6">
              <div id="trainer">
                <div id="exercise">
                  <img />
                  <p></p>
                </div>
              </div>
            </div>
          </div>
          <br />
        </div>
      </div>

      <!--canvas-->

      <br />

      <button
        class="mdc-button mdc-button--raised"
        onclick="window.location.href = 'ActiveBreak.html';"
      >
        <span class="material-icons">
          skip_previous
        </span>
      </button>
      <button class="mdc-button mdc-button--raised" onclick="startTM()">
        <span class="material-icons">
          play_arrow
        </span>
      </button>
      <button class="mdc-button mdc-button--raised" onclick="pause()">
        <span class="material-icons">
          pause
        </span>
      </button>

      <button class="mdc-button mdc-button--raised" onclick="skip()">
        <span class="material-icons">
          skip_next
        </span>
      </button>

      <button
        class="mdc-button mdc-button--raised"
        onclick="window.location.href = 'stats.html';"
      >
        <span class="material-icons">
          bar_chart
        </span>
      </button>

      <footer></footer>

      <br />

      <!-- import the Material javascript file -->
    </div>
  </main>
  <script>
    //DAS IST MEIN CODE |
    //                  v

    // More API functions here:
    // https://github.com/googlecreativelab/teachablemachine-community/tree/master/libraries/pose

    // the link to your model provided by Teachable Machine export panel
    const URL = "https://teachablemachine.withgoogle.com/models/vxiow7xHt/";
    let model, webcam, ctx, labelContainer, maxPredictions;
    var TM = document.getElementById("TM");
    var indexExercises = 0;

    async function init() {
      //ausf√ºhrungen beim starten
      startTM();
      progress(durBreak, durBreak, $("#progressBar"));
    }

    async function startTM() {
      const modelURL = URL + "model.json";
      const metadataURL = URL + "metadata.json";

      // load the model and metadata
      // Refer to tmImage.loadFromFiles() in the API to support files from a file picker
      // Note: the pose library adds a tmPose object to your window (window.tmPose)
      model = await tmPose.load(modelURL, metadataURL);
      maxPredictions = model.getTotalClasses();

      // Convenience function to setup a webcam
      const size = 200;
      const flip = true; // whether to flip the webcam
      webcam = new tmPose.Webcam(size, size, flip); // width, height, flip
      await webcam.setup(); // request access to the webcam
      await webcam.play();
      window.requestAnimationFrame(loop);

      // append/get elements to the DOM
      const canvas = document.getElementById("canvas");
      canvas.width = size;
      canvas.height = size;
      ctx = canvas.getContext("2d");
      labelContainer = document.getElementById("label-container");
      for (let i = 0; i < maxPredictions; i++) {
        // and class labels
        labelContainer.appendChild(document.createElement("div"));
      }
      TM.style.display = "block";
    }

    async function loop(timestamp) {
      webcam.update(); // update the webcam frame
      await predict();
      window.requestAnimationFrame(loop);
    }

    async function predict() {
      // Prediction #1: run input through posenet
      // estimatePose can take in an image, video or canvas html element
      const { pose, posenetOutput } = await model.estimatePose(webcam.canvas);
      // Prediction 2: run input through teachable machine classification model
      const prediction = await model.predict(posenetOutput);
      var probability = prediction[indexExercises].probability;
      var currentPose = getMax(prediction);
      //var max = Math.max.apply(Math, prediction.map(function(o) { return o.className; }))// Array Prediction wird in Map geschrieben und nach Maximum durchsucht
      showFeedback(probability, currentPose.className);

      for (let i = 0; i < maxPredictions; i++) {
        const classPrediction =
          prediction[i].className + ": " + prediction[i].probability.toFixed(2);
        labelContainer.childNodes[i].innerHTML = classPrediction;
    
      }

      // finally draw the poses
      drawPose(pose);
    
    }
function getMax(prediction) {
    var max;
    for (var i=0 ; i<prediction.length ; i++) {
        if (max == null || parseInt(prediction[i].probability.toFixed(2)) > parseInt(max.probability.toFixed(2)))
            max = prediction[i];
    }
    return max;
}
    //TODO
    function showFeedback(probability, currentPose) {
      var exerciseId = exercises[indexExercises].exerciseId;
     document.getElementById("exerciseName").innerHTML = "name: " + currentPose;
      if (currentPose == exerciseId) {
               document.getElementById("feedback").innerHTML = "Feedback: GOOD";

      }
      else {
        document.getElementById("feedback").innerHTML = "Feedback: Wrong Exercise";
      }
    }

    function drawPose(pose) {
      if (webcam.canvas) {
        ctx.drawImage(webcam.canvas, 0, 0);
        // draw the keypoints and skeleton
        if (pose) {
          const minPartConfidence = 0.5;
          tmPose.drawKeypoints(pose.keypoints, minPartConfidence, ctx);
          tmPose.drawSkeleton(pose.keypoints, minPartConfidence, ctx);
        }
      }
    }

    var aud = document.getElementById("aud");
    aud.load();
    aud.autoplay = true;
    aud.play();

    //ProgressBar
    var exercises = [
      {
        exerciseId: "raisedArms",
        exerciseName: "Raised Arms",
        alt: "Raised Arms",
        url:
          "https://cdn.glitch.com/344122ff-b96f-4b0e-b327-a5fea0abf4a7%2Fgif_raised_arms.gif?v=1596619843770"
      },
      {
        exerciseId: "wallsit",
        exerciseName: "Squad",
        alt: "Squad",
        url:
          "https://cdn.glitch.com/344122ff-b96f-4b0e-b327-a5fea0abf4a7%2Fgif_squats_red.gif?v=1596619838934"
      },
      {
        exerciseId: "march",
        exerciseName: "March",
        alt: "March",
        url:
          "https://cdn.glitch.com/344122ff-b96f-4b0e-b327-a5fea0abf4a7%2Fgif-march-red.gif?v=1596619836208"
      }
    ];
    var numberOfExercises = exercises.length; //(l√§nge des Arrays)
    var durBreak = localStorage.getItem("durBreak") * 60;
    var timeleft = durBreak;
    const intervall = timeleft / numberOfExercises;

    function progress(timeleft, timetotal, $element) {
      var progressBarWidth = (timeleft * $element.width()) / timetotal;
      drawExercise(timeleft);

      $element
        .find("div")
        .animate({ width: progressBarWidth }, 500)
        .html(Math.floor(timeleft / 60) + ":" + (timeleft % 60));
      if (timeleft > 0 && TM.style.display == "block") {
        setTimeout(function() {
          progress(timeleft - 1, timetotal, $element);
        }, 1000);
      } else {
        setTimeout(function() {
          progress(timeleft, timetotal, $element);
        }, 1000);
      }
    }

    function drawExercise(timeleft) {
      var timeTillNextExercise = timeleft % intervall;
      document.getElementById("nextExercise").innerHTML =
        "Time Left Till Next Exercise: " + timeTillNextExercise;
      if (timeleft == 0) {
        skip();
      }

      if (timeTillNextExercise == 0) {
        //1 mal je intervall Bildwechsel
        showNextExercise();
      }
       if (timeTillNextExercise == 1 && timeleft >1) {
        //1 mal je intervall Bildwechsel
        indexExercises++;
        showNextExercise();
      }
    }

    function showNextExercise() {
      var prevImg = document.getElementById("exercise").childNodes[0];
      var prevP = document.getElementById("exercise").childNodes[1];
      var img = document.createElement("img");
      var p = document.createElement("p");
      img.src = exercises[indexExercises].url; //url
      img.alt = exercises[indexExercises].alt; //alt
      p.innerHTML = exercises[indexExercises].exerciseName; //label
      exercise.replaceChild(img, prevImg);
      exercise.replaceChild(p, prevP);
    }

    function pause() {
      TM.style.display = "none";
      var prevImg = document.getElementById("exercise").childNodes[0];
      var prevP = document.getElementById("exercise").childNodes[1];
      exercise.removeChild(prevImg);
      exercise.removeChild(prevP);
      webcam.stop();
    }

    function skip() {
      window.location.href = "Work.html";
    }
  </script>
</body>
<!--TM-->
